<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi-Guy Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --blue: #0088ff;
            --blue-dim: #0055aa;
            --blue-bright: #00aaff;
            --red: #ff2244;
            --red-dim: #aa1133;
            --red-bright: #ff4466;
            --orange: #ff6600;
            --dark-bg: #050508;
            --panel-bg: #0a0a12;
            --glow-blue: 0 0 20px #0088ff, 0 0 40px #0088ff44, 0 0 60px #0088ff22;
            --glow-red: 0 0 20px #ff2244, 0 0 40px #ff224444, 0 0 60px #ff224422;
        }

        body {
            background: var(--dark-bg);
            font-family: 'Courier New', monospace;
            color: var(--blue);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Animated background grid */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(0,136,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,136,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        .dashboard {
            display: grid;
            grid-template-columns: minmax(180px, 0.9fr) minmax(620px, 2.2fr) minmax(180px, 0.9fr);
            grid-template-rows: auto minmax(240px, 1fr) minmax(240px, 1fr) minmax(300px, auto);
            grid-template-areas:
                "header header header"
                "cpu face temp"
                "memory face disk"
                "chat chat chat";
            gap: 6px;
            padding: 10px;
            height: 100vh;
        }

        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 2px solid var(--blue);
            box-shadow: var(--glow-blue);
        }

        .header h1 {
            font-size: 2rem;
            text-transform: uppercase;
            letter-spacing: 10px;
            text-shadow: var(--glow-blue);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--blue-dim);
            border-radius: 6px;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }

        .panel.full-span {
            grid-column: 1 / -1;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--blue), transparent);
            animation: scan-line 3s linear infinite;
        }

        @keyframes scan-line {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .panel-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
            color: var(--blue-dim);
        }

        /* Gauge container */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100% - 30px);
        }

        /* SVG Gauge styling */
        .gauge {
            width: 100%;
            max-width: 128px;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .gauge-bg {
            fill: none;
            stroke: #1a1a2e;
            stroke-width: 20;
        }

        .gauge-fill {
            fill: none;
            stroke-width: 20;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-out, stroke 0.3s ease;
            filter: drop-shadow(0 0 8px currentColor);
        }

        .gauge-fill { stroke: url(#gaugeGradient); }

        .gauge-text {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: bold;
            fill: currentColor;
            text-anchor: middle;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .gauge-label {
            font-size: 0.6rem;
            fill: #666;
            text-anchor: middle;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .scale-text {
            font-size: 0.52rem;
            fill: #555;
            font-family: 'Courier New', monospace;
        }

        .gauge-ticks {
            fill: none;
            stroke: #333;
            stroke-width: 2;
        }

        /* Glow effect on hover */
        .panel:hover {
            border-color: var(--blue);
            box-shadow: inset 0 0 30px rgba(0, 136, 255, 0.1),
                        0 0 20px rgba(0, 136, 255, 0.3);
        }

        /* Stats display */
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #222;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 0.8rem;
            color: var(--blue);
            text-shadow: 0 0 10px var(--blue);
        }

        .stat-label {
            font-size: 0.5rem;
            color: #555;
            text-transform: uppercase;
        }

        /* Network panel special styling */
        .network-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }

        .network-bar {
            position: relative;
        }

        .network-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .network-bar-track {
            height: 20px;
            background: #1a1a2e;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .network-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .network-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent,
                rgba(255,255,255,0.3),
                transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .network-bar-fill.upload {
            background: linear-gradient(90deg, var(--red-dim), var(--red));
            box-shadow: 0 0 20px var(--red);
        }

        .network-bar-fill.download {
            background: linear-gradient(90deg, var(--blue-dim), var(--blue));
            box-shadow: 0 0 20px var(--blue);
        }

        /* Corner decorations */
        .corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: var(--blue);
            border-style: solid;
        }

        .corner-tl { top: 5px; left: 5px; border-width: 2px 0 0 2px; }
        .corner-tr { top: 5px; right: 5px; border-width: 2px 2px 0 0; }
        .corner-bl { bottom: 5px; left: 5px; border-width: 0 0 2px 2px; }
        .corner-br { bottom: 5px; right: 5px; border-width: 0 2px 2px 0; }

        /* Warning state */
        .warning .gauge-fill {
            stroke: var(--orange) !important;
            animation: warning-pulse 0.5s ease-in-out infinite;
        }

        .danger .gauge-fill {
            stroke: var(--red) !important;
            animation: danger-pulse 0.3s ease-in-out infinite;
        }

        @keyframes warning-pulse {
            0%, 100% { filter: drop-shadow(0 0 8px var(--orange)); }
            50% { filter: drop-shadow(0 0 20px var(--orange)); }
        }

        @keyframes danger-pulse {
            0%, 100% { filter: drop-shadow(0 0 10px var(--red)); }
            50% { filter: drop-shadow(0 0 30px var(--red)); }
        }

        .dashboard-shell {
            height: 100vh;
        }

        .dashboard-main {
            min-height: 0;
        }

        .header { grid-area: header; }
        #cpu-panel { grid-area: cpu; }
        #temp-panel { grid-area: temp; }
        #memory-panel { grid-area: memory; }
        #disk-panel { grid-area: disk; }
        .face-panel { grid-area: face; min-height: 100%; display: flex; flex-direction: column; }
        #cpu-panel,
        #temp-panel,
        #memory-panel,
        #disk-panel {
            width: 100%;
            max-width: 100%;
            min-height: 0;
            align-self: stretch;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #cpu-panel .panel-title,
        #temp-panel .panel-title,
        #memory-panel .panel-title,
        #disk-panel .panel-title {
            font-size: 0.6rem;
            letter-spacing: 1.5px;
            margin-bottom: 4px;
        }


        .drawer-toggle {
            background: #0b1a2e;
            border: 1px solid #1b233a;
            color: var(--blue);
            padding: 8px 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }

        .settings-drawer {
            position: relative;
            top: 0;
            width: min(320px, 28vw);
            max-height: calc(100vh - 120px);
            overflow: auto;
            background: rgba(8, 10, 20, 0.97);
            border: 1px solid #1b233a;
            border-radius: 12px;
            padding: 12px;
            z-index: 30;
        }

        .settings-drawer.left { justify-self: start; }
        .settings-drawer.right { justify-self: end; }

        .settings-drawer summary {
            cursor: pointer;
            color: var(--blue-bright);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .settings-grid {
            display: grid;
            gap: 8px;
        }

        .settings-grid input,
        .settings-grid select,
        .settings-grid button,
        .settings-grid label { font-size: 0.75rem; }
        .chat-dock { grid-area: chat; min-width: 0; justify-self: stretch; width: 100%; margin-top: 0; }

        .header-center {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 10px;
        }

        .header h1 { font-size: 1.3rem; letter-spacing: 6px; margin-bottom: 6px; }

        .top-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .face-grid {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: minmax(260px, 1fr) auto;
            gap: 8px;
            height: 100%;
            align-items: stretch;
            flex: 1 1 auto;
            min-height: 0;
        }

        .face-viewport {
            min-height: 0;
            position: relative;
            border-radius: 14px;
            border: 1px solid #1b233a;
            overflow: hidden;
            background: radial-gradient(circle at top, rgba(0, 136, 255, 0.15), rgba(5, 5, 8, 0.95));
            box-shadow: inset 0 0 30px rgba(0, 136, 255, 0.15),
                        0 0 25px rgba(0, 136, 255, 0.25);
            min-height: 240px;
        }

        .face-viewport::after {
            content: '';
            position: absolute;
            inset: 8px;
            border-radius: 10px;
            border: 1px solid rgba(0, 170, 255, 0.25);
            pointer-events: none;
        }

        .face-viewport iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .face-overlay {
            position: absolute;
            top: 12px;
            left: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(5, 8, 16, 0.7);
            border: 1px solid rgba(0, 170, 255, 0.4);
            border-radius: 999px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--blue-bright);
            z-index: 2;
        }

        .face-overlay .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.8);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .duplex-controls {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 6px;
        }

        .duplex-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--blue-dim);
        }

        .duplex-status {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .duplex-pill {
            border: 1px solid #1b233a;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(8, 12, 24, 0.8);
            color: #8fb8ff;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .duplex-pill span {
            font-weight: bold;
            color: var(--blue-bright);
        }

        .status-light {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #7d8cb5;
            box-shadow: 0 0 8px rgba(125, 140, 181, 0.5);
        }

        .status-light.live {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }

        .status-light.busy {
            background: #ffdd55;
            box-shadow: 0 0 10px rgba(255, 221, 85, 0.7);
        }

        .duplex-actions {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .duplex-actions button,
        .top-controls button {
            background: #0b1a2e;
            border: 1px solid #1b233a;
            color: var(--blue);
            padding: 10px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .duplex-actions button:hover,
        .top-controls button:hover {
            border-color: var(--blue);
            box-shadow: 0 0 12px rgba(0, 136, 255, 0.35);
        }

        .duplex-actions button:active,
        .top-controls button:active {
            transform: scale(0.98);
        }

        .duplex-actions button.primary,
        .top-controls button.primary {
            background: linear-gradient(120deg, rgba(0, 136, 255, 0.35), rgba(0, 255, 170, 0.2));
            border-color: rgba(0, 170, 255, 0.6);
            color: #c8ecff;
        }

        .duplex-actions button.danger,
        .top-controls button.danger {
            border-color: rgba(255, 68, 102, 0.6);
            color: #ff99aa;
        }

        .duplex-actions button.active,
        .top-controls button.active {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            border-color: rgba(0, 255, 255, 0.8);
        }

        .duplex-notes {
            font-size: 0.75rem;
            color: #6c7aa5;
            line-height: 1.4;
            border: 1px solid #1b233a;
            border-radius: 10px;
            padding: 10px 12px;
            background: rgba(8, 10, 20, 0.75);
        }

        .chat-dock {
            border-top: 1px solid var(--blue-dim);
            background: linear-gradient(180deg, rgba(5, 5, 8, 0.98), rgba(10, 10, 18, 0.98));
            box-shadow: 0 -10px 30px rgba(0, 136, 255, 0.2);
            padding: 12px 15px 16px;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }

        .chat-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--blue-dim);
        }

        .chat-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.7rem;
            color: #6c7aa5;
        }

        .chat-controls label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .chat-body {
            display: grid;
            grid-template-columns: minmax(0, 1.6fr) minmax(320px, 1fr);
            gap: 12px;
            align-items: stretch;
        }

        .chat-log {
            border: 1px solid #1b233a;
            border-radius: 10px;
            background: rgba(8, 10, 20, 0.8);
            padding: 10px;
            height: 100%;
            min-height: 210px;
            overflow-y: auto;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .chat-message:last-child {
            margin-bottom: 0;
        }

        .chat-message .tag {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--blue-bright);
            min-width: 70px;
        }

        .chat-message.assistant .tag {
            color: #9ad1ff;
        }

        .chat-message.system .tag {
            color: var(--orange);
        }

        .chat-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-inputs textarea {
            resize: none;
            height: 90px;
            background: #0b0f1a;
            border: 1px solid #1b233a;
            border-radius: 8px;
            color: #d2e6ff;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .chat-actions {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .chat-actions.primary-actions {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .chat-actions.secondary-actions {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .chat-actions button,
        .chat-actions input[type="file"]::file-selector-button {
            background: #0b1a2e;
            border: 1px solid #1b233a;
            color: var(--blue);
            padding: 8px 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s ease;
        }

        .chat-actions button:hover,
        .chat-actions input[type="file"]::file-selector-button:hover {
            border-color: var(--blue);
            box-shadow: 0 0 12px rgba(0, 136, 255, 0.35);
        }

        .chat-actions button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-meta {
            font-size: 0.7rem;
            color: #6c7aa5;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            border: 1px solid #1b233a;
            border-radius: 8px;
            padding: 6px 8px;
            background: rgba(8, 12, 22, 0.65);
        }

        .chat-meta .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #0b1a2e;
            border: 1px solid #1b233a;
            margin-right: 6px;
        }

        .launchpad {
            margin-top: 10px;
            border: 1px solid #1b233a;
            border-radius: 10px;
            padding: 10px;
            background: rgba(7, 11, 19, 0.85);
        }

        .launchpad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .launchpad-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #7ab8ff;
        }

        .launchpad-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
        }

        .phase-card {
            border: 1px solid #223257;
            border-radius: 8px;
            padding: 8px;
            background: rgba(10, 15, 28, 0.95);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .phase-card h4 {
            font-size: 0.8rem;
            color: #b5dcff;
            letter-spacing: 1px;
        }

        .phase-card ul {
            padding-left: 16px;
            font-size: 0.72rem;
            line-height: 1.4;
            color: #9dafd1;
        }

        .phase-card li {
            margin-bottom: 4px;
        }

        .phase-card label {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            cursor: pointer;
        }

        .launchpad-footer {
            margin-top: 8px;
            font-size: 0.68rem;
            color: #6781ae;
        }

        @media (max-width: 1100px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto auto auto;
                grid-template-areas:
                    "header"
                    "face"
                    "chat"
                    "cpu"
                    "temp"
                    "memory"
                    "disk";
                height: auto;
                min-height: 100vh;
                padding-bottom: 20px;
            }

            #cpu-panel,
            #temp-panel,
            #memory-panel,
            #disk-panel {
                aspect-ratio: auto;
                min-height: 210px;
            }

            .header-center {
                grid-template-columns: 1fr;
            }

            .chat-body {
                grid-template-columns: 1fr;
            }

            .chat-actions.primary-actions {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .launchpad-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- SVG Gradient Definition -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#00ff66;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#ffdd00;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ff2244;stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <div class="dashboard-shell">
        <div class="dashboard-main">
            <div class="dashboard">
                <header class="header">
                    <div class="header-center">
                        <details class="settings-drawer left">
                            <summary>System Drawer</summary>
                            <div class="settings-grid">
                                <label><input type="checkbox" id="chat-mute"> Mute Audio Out</label>
                                <label><input type="checkbox" id="chat-vision"> Use Local Vision</label>
                                <label for="model-provider">Provider</label>
                                <select id="model-provider"></select>
                                <button id="model-settings-save" type="button">Save Models</button>
                                                            <small>Use your browser's OAuth popup flow for persistence and account linking.</small>
                            </div>
                        </details>
                        <div>
                            <h1>Pi-Guy</h1>
                            <div class="top-controls">
                                <div class="duplex-pill"><span class="status-light" id="socket-light"></span> Socket: <span id="duplex-socket">offline</span></div>
                                <div class="duplex-pill"><span class="status-light" id="voice-light"></span> Voice: <span id="duplex-voice">idle</span></div>
                                <div class="duplex-pill"><span class="status-light" id="mic-light"></span> Mic: <span id="duplex-mic">ready</span></div>
                                <div class="duplex-pill">Mood: <span id="duplex-mood">neutral</span></div>
                                <button class="primary" id="duplex-talk">Push-to-Talk</button>
                                <button id="duplex-listen">Listen Once</button>
                                <button class="primary" id="duplex-auto">Auto Duplex</button>
                                <button id="duplex-blink">Blink</button>
                                <button class="danger" id="duplex-reset">Reset Mood</button>
                            </div>
                        </div>
                        <details class="settings-drawer right">
                            <summary>Model Drawer</summary>
                            <div class="settings-grid">
                                <input id="text-model-input" placeholder="Text model (e.g. llama3.1:8b)">
                                <input id="vision-model-input" placeholder="Vision model (e.g. llama3.2-vision)">
                                <input id="model-endpoint-input" placeholder="API base (e.g. http://localhost:11434)">
                                <input id="fallback-text-model" placeholder="Fallback transformers.js model">
                                <input id="fallback-diffusion-model" placeholder="Fallback diffusers.js/CDN model">
                                <input id="fallback-audio-model" placeholder="Fallback audio CDN model">
                            </div>
                        </details>
                    </div>
                </header>

                <div class="panel face-panel">
                    <div class="corner corner-tl"></div>
                    <div class="corner corner-tr"></div>
                    <div class="corner corner-bl"></div>
                    <div class="corner corner-br"></div>
                    <div class="panel-title">Full Duplex Avatar</div>
                    <div class="face-grid">
                        <div class="face-viewport">
                            <div class="face-overlay">
                                <span class="dot"></span>
                                <span id="duplex-link-label">Link Active</span>
                            </div>
                            <iframe id="duplex-face" src="/face?embed=1" title="Pi-Guy Face"></iframe>
                        </div>
                        <div class="duplex-notes">
                            Duplex routing now supports proactive full-duplex turns with browser ASR, optional vision context, and layered memory/tool retrieval over the active conversation.
                        </div>
                    </div>
                </div>

                <!-- CPU Gauge -->
                <div class="panel" id="cpu-panel">
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
            <div class="panel-title">CPU Usage</div>
            <div class="gauge-container">
                <svg class="gauge" viewBox="0 0 200 160">
                    <!-- Tick marks -->
                    <g class="gauge-ticks">
                        <line x1="30" y1="130" x2="35" y2="125" stroke="#444"/>
                        <line x1="20" y1="100" x2="27" y2="100" stroke="#444"/>
                        <line x1="30" y1="70" x2="35" y2="75" stroke="#444"/>
                        <line x1="60" y1="45" x2="63" y2="52" stroke="#444"/>
                        <line x1="100" y1="35" x2="100" y2="43" stroke="#444"/>
                        <line x1="140" y1="45" x2="137" y2="52" stroke="#444"/>
                        <line x1="170" y1="70" x2="165" y2="75" stroke="#444"/>
                        <line x1="180" y1="100" x2="173" y2="100" stroke="#444"/>
                        <line x1="170" y1="130" x2="165" y2="125" stroke="#444"/>
                    </g>
                    <!-- Scale numbers -->
                    <text class="scale-text" x="18" y="138">0</text>
                    <text class="scale-text" x="8" y="100">25</text>
                    <text class="scale-text" x="22" y="62">50</text>
                    <text class="scale-text" x="95" y="28">75</text>
                    <text class="scale-text" x="172" y="62">100</text>
                    <!-- Background arc -->
                    <path class="gauge-bg" d="M 30 130 A 70 70 0 1 1 170 130"/>
                    <!-- Value arc -->
                    <path class="gauge-fill" id="cpu-fill" d="M 30 130 A 70 70 0 0 1 100 60"
                          stroke-dasharray="330" stroke-dashoffset="330"/>
                    <!-- Center text -->
                    <text class="gauge-text" x="100" y="115" id="cpu-value" fill="#00ff66">0%</text>
                    <text class="gauge-label" x="100" y="150">percent</text>
                </svg>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="cpu-freq">0</div>
                    <div class="stat-label">MHz</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cpu-cores">4</div>
                    <div class="stat-label">Cores</div>
                </div>
            </div>
        </div>

        <!-- Temperature Gauge -->
        <div class="panel" id="temp-panel">
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
            <div class="panel-title">Temperature</div>
            <div class="gauge-container">
                <svg class="gauge" viewBox="0 0 200 160">
                    <g class="gauge-ticks">
                        <line x1="30" y1="130" x2="35" y2="125" stroke="#444"/>
                        <line x1="20" y1="100" x2="27" y2="100" stroke="#444"/>
                        <line x1="30" y1="70" x2="35" y2="75" stroke="#444"/>
                        <line x1="60" y1="45" x2="63" y2="52" stroke="#444"/>
                        <line x1="100" y1="35" x2="100" y2="43" stroke="#444"/>
                        <line x1="140" y1="45" x2="137" y2="52" stroke="#444"/>
                        <line x1="170" y1="70" x2="165" y2="75" stroke="#444"/>
                        <line x1="180" y1="100" x2="173" y2="100" stroke="#444"/>
                        <line x1="170" y1="130" x2="165" y2="125" stroke="#444"/>
                    </g>
                    <!-- Scale numbers (0-85°C) -->
                    <text class="scale-text" x="18" y="138">0°</text>
                    <text class="scale-text" x="5" y="100">21°</text>
                    <text class="scale-text" x="19" y="62">42°</text>
                    <text class="scale-text" x="92" y="28">64°</text>
                    <text class="scale-text" x="172" y="62">85°</text>
                    <path class="gauge-bg" d="M 30 130 A 70 70 0 1 1 170 130"/>
                    <path class="gauge-fill" id="temp-fill" d="M 30 130 A 70 70 0 0 1 100 60"
                          stroke-dasharray="330" stroke-dashoffset="330"/>
                    <text class="gauge-text" x="100" y="115" id="temp-value" fill="#00ff66">0°</text>
                    <text class="gauge-label" x="100" y="150">celsius</text>
                </svg>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value">85°</div>
                    <div class="stat-label">Max Safe</div>
                </div>
            </div>
        </div>

        <!-- Memory Gauge -->
        <div class="panel" id="memory-panel">
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
            <div class="panel-title">Memory</div>
            <div class="gauge-container">
                <svg class="gauge" viewBox="0 0 200 160">
                    <g class="gauge-ticks">
                        <line x1="30" y1="130" x2="35" y2="125" stroke="#444"/>
                        <line x1="20" y1="100" x2="27" y2="100" stroke="#444"/>
                        <line x1="30" y1="70" x2="35" y2="75" stroke="#444"/>
                        <line x1="60" y1="45" x2="63" y2="52" stroke="#444"/>
                        <line x1="100" y1="35" x2="100" y2="43" stroke="#444"/>
                        <line x1="140" y1="45" x2="137" y2="52" stroke="#444"/>
                        <line x1="170" y1="70" x2="165" y2="75" stroke="#444"/>
                        <line x1="180" y1="100" x2="173" y2="100" stroke="#444"/>
                        <line x1="170" y1="130" x2="165" y2="125" stroke="#444"/>
                    </g>
                    <!-- Scale numbers -->
                    <text class="scale-text" x="18" y="138">0</text>
                    <text class="scale-text" x="8" y="100">25</text>
                    <text class="scale-text" x="22" y="62">50</text>
                    <text class="scale-text" x="95" y="28">75</text>
                    <text class="scale-text" x="172" y="62">100</text>
                    <path class="gauge-bg" d="M 30 130 A 70 70 0 1 1 170 130"/>
                    <path class="gauge-fill" id="memory-fill" d="M 30 130 A 70 70 0 0 1 100 60"
                          stroke-dasharray="330" stroke-dashoffset="330"/>
                    <text class="gauge-text" x="100" y="115" id="memory-value" fill="#00ff66">0%</text>
                    <text class="gauge-label" x="100" y="150">used</text>
                </svg>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="memory-used">0</div>
                    <div class="stat-label">GB Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="memory-total">8</div>
                    <div class="stat-label">GB Total</div>
                </div>
            </div>
        </div>

                <!-- Disk Gauge -->
                <div class="panel" id="disk-panel">
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
            <div class="panel-title">Disk Storage</div>
            <div class="gauge-container">
                <svg class="gauge" viewBox="0 0 200 160">
                    <g class="gauge-ticks">
                        <line x1="30" y1="130" x2="35" y2="125" stroke="#444"/>
                        <line x1="20" y1="100" x2="27" y2="100" stroke="#444"/>
                        <line x1="30" y1="70" x2="35" y2="75" stroke="#444"/>
                        <line x1="60" y1="45" x2="63" y2="52" stroke="#444"/>
                        <line x1="100" y1="35" x2="100" y2="43" stroke="#444"/>
                        <line x1="140" y1="45" x2="137" y2="52" stroke="#444"/>
                        <line x1="170" y1="70" x2="165" y2="75" stroke="#444"/>
                        <line x1="180" y1="100" x2="173" y2="100" stroke="#444"/>
                        <line x1="170" y1="130" x2="165" y2="125" stroke="#444"/>
                    </g>
                    <!-- Scale numbers -->
                    <text class="scale-text" x="18" y="138">0</text>
                    <text class="scale-text" x="8" y="100">25</text>
                    <text class="scale-text" x="22" y="62">50</text>
                    <text class="scale-text" x="95" y="28">75</text>
                    <text class="scale-text" x="172" y="62">100</text>
                    <path class="gauge-bg" d="M 30 130 A 70 70 0 1 1 170 130"/>
                    <path class="gauge-fill" id="disk-fill" d="M 30 130 A 70 70 0 0 1 100 60"
                          stroke-dasharray="330" stroke-dashoffset="330"/>
                    <text class="gauge-text" x="100" y="115" id="disk-value" fill="#00ff66">0%</text>
                    <text class="gauge-label" x="100" y="150">used</text>
                </svg>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="disk-used">0</div>
                    <div class="stat-label">GB Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="disk-total">64</div>
                    <div class="stat-label">GB Total</div>
                </div>
            </div>
                </div>
            </div>
        </div>

        <section class="chat-dock">
            <div class="chat-header">
                <div class="chat-title">Conversation Dock</div>
            </div>
            <div class="chat-body">
                <div class="chat-log" id="chat-log" aria-live="polite"></div>
                <div class="chat-inputs">
                    <textarea id="chat-input" placeholder="Type a message or use the mic to talk..."></textarea>
                    <div class="chat-actions primary-actions">
                        <button id="chat-send">Send</button>
                        <button id="chat-voice">Voice Input</button>
                        <input type="file" id="chat-image" accept="image/*">
                        <button id="chat-clear">Clear</button>
                    </div>
                    <div class="chat-meta">
                        <span class="pill">Text model: <span id="text-model-label"></span></span>
                        <span class="pill">Vision model: <span id="vision-model-label"></span></span>
                        <span id="chat-status">Ready.</span>
                    </div>
                    <div class="chat-meta">
                        <span class="pill">Runtime Tools</span>
                        <label><input type="checkbox" id="allow-web-inspect"> Web Inspect</label>
                        <label><input type="checkbox" id="allow-local-files"> Local Files</label>
                        <label><input type="checkbox" id="allow-local-folders"> Local Folders</label>
                        <label><input type="checkbox" id="allow-github-workflows"> GitHub Workflows</label>
                    </div>
                    <div class="chat-actions secondary-actions">
                        <button id="connect-github" type="button">Connect GitHub</button>
                        <button id="connect-google" type="button">Connect Google</button>
                        <button id="scan-local-content" type="button">Index Local Content</button>
                        <button id="scan-remote-content" type="button">Inspect Website</button>
                    </div>
                    <section class="launchpad" aria-label="Agentic roadmap">
                        <div class="launchpad-header">
                            <div class="launchpad-title">Agentic Launchpad · V1 / V2 / V3</div>
                            <button id="launchpad-reset" type="button">Reset</button>
                        </div>
                        <div class="launchpad-grid">
                            <article class="phase-card">
                                <h4>V1 · Foundation</h4>
                                <ul>
                                    <li><label><input type="checkbox" data-launchpad="v1-mission"> Mission Control dashboard with current goals + blockers</label></li>
                                    <li><label><input type="checkbox" data-launchpad="v1-plan"> Auto plan decomposition into milestones</label></li>
                                    <li><label><input type="checkbox" data-launchpad="v1-logs"> Action logs + permission prompts</label></li>
                                </ul>
                            </article>
                            <article class="phase-card">
                                <h4>V2 · Power Mode</h4>
                                <ul>
                                    <li><label><input type="checkbox" data-launchpad="v2-parallel"> Parallel specialist agents (planner, builder, QA)</label></li>
                                    <li><label><input type="checkbox" data-launchpad="v2-tools"> Browser / terminal / docs tool orchestration</label></li>
                                    <li><label><input type="checkbox" data-launchpad="v2-snapshots"> Snapshot time-machine rollback</label></li>
                                </ul>
                            </article>
                            <article class="phase-card">
                                <h4>V3 · Legend Tier</h4>
                                <ul>
                                    <li><label><input type="checkbox" data-launchpad="v3-heal"> Self-healing autonomy with retries and escalation</label></li>
                                    <li><label><input type="checkbox" data-launchpad="v3-map"> Live reasoning map + confidence/risk meter</label></li>
                                    <li><label><input type="checkbox" data-launchpad="v3-team"> Team personas + handoff packets</label></li>
                                </ul>
                            </article>
                        </div>
                        <div class="launchpad-footer" id="launchpad-status">No milestones complete yet.</div>
                    </section>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Connect to WebSocket
        const socket = io();

        // Arc calculation constants
        const ARC_LENGTH = 330; // Total arc length
        const MAX_TEMP = 85; // Max safe temperature

        // Get color based on percentage (green -> yellow -> red)
        function getGradientColor(percent) {
            if (percent < 50) {
                // Green to Yellow (0-50%)
                const ratio = percent / 50;
                const r = Math.round(255 * ratio);
                const g = 255;
                const b = Math.round(102 * (1 - ratio));
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // Yellow to Red (50-100%)
                const ratio = (percent - 50) / 50;
                const r = 255;
                const g = Math.round(221 * (1 - ratio) + 34 * ratio);
                const b = Math.round(68 * ratio);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }

        // Update gauge arc
        function updateGauge(fillId, percent, panelId, textId, thresholds = {warning: 70, danger: 90}) {
            const fill = document.getElementById(fillId);
            const panel = document.getElementById(panelId);
            const text = document.getElementById(textId);

            // Calculate stroke-dashoffset (330 = empty, 0 = full)
            const offset = ARC_LENGTH - (ARC_LENGTH * (percent / 100));
            fill.style.strokeDashoffset = offset;

            // Update text color based on percentage
            const color = getGradientColor(percent);
            if (text) {
                text.setAttribute('fill', color);
            }

            // Update warning/danger states
            panel.classList.remove('warning', 'danger');
            if (percent >= thresholds.danger) {
                panel.classList.add('danger');
            } else if (percent >= thresholds.warning) {
                panel.classList.add('warning');
            }
        }

        // Format bytes to human readable
        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }

        // Handle stats updates
        socket.on('stats_update', (data) => {
            // CPU
            updateGauge('cpu-fill', data.cpu.percent, 'cpu-panel', 'cpu-value');
            document.getElementById('cpu-value').textContent = Math.round(data.cpu.percent) + '%';
            document.getElementById('cpu-freq').textContent = Math.round(data.cpu.freq);
            document.getElementById('cpu-cores').textContent = data.cpu.cores;

            // Temperature (scale 0-85°C to 0-100%)
            const tempPercent = Math.min((data.cpu.temp / MAX_TEMP) * 100, 100);
            updateGauge('temp-fill', tempPercent, 'temp-panel', 'temp-value', {warning: 70, danger: 85});
            document.getElementById('temp-value').textContent = data.cpu.temp + '°';

            // Memory
            updateGauge('memory-fill', data.memory.percent, 'memory-panel', 'memory-value');
            document.getElementById('memory-value').textContent = Math.round(data.memory.percent) + '%';
            document.getElementById('memory-used').textContent = data.memory.used;
            document.getElementById('memory-total').textContent = data.memory.total;

            // Disk
            updateGauge('disk-fill', data.disk.percent, 'disk-panel', 'disk-value', {warning: 80, danger: 95});
            document.getElementById('disk-value').textContent = Math.round(data.disk.percent) + '%';
            document.getElementById('disk-used').textContent = data.disk.used;
            document.getElementById('disk-total').textContent = data.disk.total;
        });

        socket.on('connect', () => {
            console.log('Connected to Pi-Guy Dashboard');
            setDuplexStatus(duplexSocket, 'online');
            if (duplexLinkLabel) {
                duplexLinkLabel.textContent = 'Link Active';
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            setDuplexStatus(duplexSocket, 'offline');
            if (duplexLinkLabel) {
                duplexLinkLabel.textContent = 'Link Offline';
            }
        });

        socket.on('set_mood', (data) => {
            if (data && data.mood) {
                setDuplexMood(data.mood);
            }
        });

        let CHAT_TEXT_MODEL = 'llama3.1:8b';
        let CHAT_VISION_MODEL = 'llama3.2-vision';
        const chatLog = document.getElementById('chat-log');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatVoice = document.getElementById('chat-voice');
        const chatClear = document.getElementById('chat-clear');
        const chatMute = document.getElementById('chat-mute');
        const chatVisionToggle = document.getElementById('chat-vision');
        const chatImage = document.getElementById('chat-image');
        const chatStatus = document.getElementById('chat-status');
        const textModelLabel = document.getElementById('text-model-label');
        const visionModelLabel = document.getElementById('vision-model-label');
        const modelProvider = document.getElementById('model-provider');
        const modelSettingsSave = document.getElementById('model-settings-save');
        const textModelInput = document.getElementById('text-model-input');
        const visionModelInput = document.getElementById('vision-model-input');
        const modelEndpointInput = document.getElementById('model-endpoint-input');
        const fallbackTextModelInput = document.getElementById('fallback-text-model');
        const fallbackDiffusionModelInput = document.getElementById('fallback-diffusion-model');
        const fallbackAudioModelInput = document.getElementById('fallback-audio-model');
        const duplexSocket = document.getElementById('duplex-socket');
        const duplexVoice = document.getElementById('duplex-voice');
        const duplexMic = document.getElementById('duplex-mic');
        const duplexMood = document.getElementById('duplex-mood');
        const duplexLinkLabel = document.getElementById('duplex-link-label');
        const duplexTalk = document.getElementById('duplex-talk');
        const duplexListen = document.getElementById('duplex-listen');
        const duplexAuto = document.getElementById('duplex-auto');
        const duplexBlink = document.getElementById('duplex-blink');
        const duplexReset = document.getElementById('duplex-reset');
        const duplexFace = document.getElementById('duplex-face');
        const socketLight = document.getElementById('socket-light');
        const voiceLight = document.getElementById('voice-light');
        const micLight = document.getElementById('mic-light');
        const chatMessages = [];
        let isSending = false;
        let realtimeSessionId = null;
        let autoDuplexEnabled = false;
        let autoDuplexTimer = null;

        syncModelLabels();
        loadModelSettings();
        setDuplexStatus(duplexSocket, 'offline');
        setDuplexStatus(duplexVoice, 'idle');
        setDuplexStatus(duplexMic, 'ready');


        function syncModelLabels() {
            textModelLabel.textContent = CHAT_TEXT_MODEL;
            visionModelLabel.textContent = CHAT_VISION_MODEL;
            textModelInput.value = CHAT_TEXT_MODEL;
            visionModelInput.value = CHAT_VISION_MODEL;
        }

        async function loadModelSettings() {
            try {
                const response = await fetch('/api/settings/models');
                const data = await response.json();
                if (data.status !== 'ok') {
                    throw new Error(data.message || 'Unable to load model settings');
                }
                const settings = data.settings || {};
                CHAT_TEXT_MODEL = settings.text_model || CHAT_TEXT_MODEL;
                CHAT_VISION_MODEL = settings.vision_model || CHAT_VISION_MODEL;
                modelEndpointInput.value = settings.api_base || '';
                fallbackTextModelInput.value = settings.fallback?.text_model || '';
                fallbackDiffusionModelInput.value = settings.fallback?.diffusion_model || '';
                fallbackAudioModelInput.value = settings.fallback?.audio_model || '';

                modelProvider.innerHTML = '';
                (data.provider_presets || []).forEach((preset) => {
                    const option = document.createElement('option');
                    option.value = preset.id;
                    option.textContent = `${preset.label} (${preset.api_base})`;
                    if (preset.id === settings.provider) {
                        option.selected = true;
                    }
                    modelProvider.appendChild(option);
                });
                syncModelLabels();
            } catch (error) {
                appendMessage('system', `Settings load error: ${error.message}`);
            }
        }

        async function saveModelSettings() {
            const payload = {
                provider: modelProvider.value,
                api_base: modelEndpointInput.value.trim(),
                text_model: textModelInput.value.trim(),
                vision_model: visionModelInput.value.trim(),
                fallback: {
                    text_model: fallbackTextModelInput.value.trim(),
                    diffusion_model: fallbackDiffusionModelInput.value.trim(),
                    audio_model: fallbackAudioModelInput.value.trim(),
                }
            };
            const response = await fetch('/api/settings/models', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.status !== 'ok') {
                throw new Error(data.message || 'Failed to save model settings');
            }
            CHAT_TEXT_MODEL = data.settings.text_model || CHAT_TEXT_MODEL;
            CHAT_VISION_MODEL = data.settings.vision_model || CHAT_VISION_MODEL;
            syncModelLabels();
        }

        function setStatus(message) {
            chatStatus.textContent = message;
        }

        function setDuplexStatus(element, label) {
            if (element) {
                element.textContent = label;
            }
            const normalized = (label || '').toLowerCase();
            if (element === duplexSocket && socketLight) {
                socketLight.classList.toggle('live', normalized === 'online' || normalized === 'connected');
            }
            if (element === duplexVoice && voiceLight) {
                voiceLight.classList.toggle('live', normalized === 'speaking');
                voiceLight.classList.toggle('busy', normalized === 'processing');
            }
            if (element === duplexMic && micLight) {
                micLight.classList.toggle('live', normalized === 'listening' || normalized === 'captured');
                micLight.classList.toggle('busy', normalized === 'processing');
            }
        }

        function setDuplexMood(mood) {
            setDuplexStatus(duplexMood, mood);
        }

        function appendMessage(role, content) {
            const entry = document.createElement('div');
            entry.className = `chat-message ${role}`;
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.textContent = role === 'assistant' ? 'Pi-Guy' : role;
            const body = document.createElement('div');
            body.textContent = content;
            entry.appendChild(tag);
            entry.appendChild(body);
            chatLog.appendChild(entry);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function storeMessage(role, content) {
            chatMessages.push({ role, content });
            if (chatMessages.length > 12) {
                chatMessages.shift();
            }
        }

        async function speakText(text) {
            if (chatMute.checked) {
                return;
            }
            try {
                setDuplexStatus(duplexVoice, 'speaking');
                const response = await fetch('/api/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await response.json();
                if (data.status !== 'ok') {
                    throw new Error(data.message || 'TTS failed');
                }
                if (data.base64 && !duplexFace) {
                    const audio = new Audio(`data:${data.mime};base64,${data.base64}`);
                    audio.play();
                }
                setDuplexStatus(duplexVoice, 'idle');
            } catch (error) {
                appendMessage('system', `Audio error: ${error.message}`);
                setDuplexStatus(duplexVoice, 'error');
            }
        }

        async function sendChat() {
            const content = chatInput.value.trim();
            if (!content || isSending) {
                return;
            }
            isSending = true;
            chatSend.disabled = true;
            setStatus('Sending to local model...');
            appendMessage('user', content);
            storeMessage('user', content);
            chatInput.value = '';

            const useVision = chatVisionToggle.checked && chatImage.files.length > 0;
            try {
                let responseData;
                setDuplexStatus(duplexVoice, 'processing');
                if (useVision) {
                    const file = chatImage.files[0];
                    const imageBase64 = await fileToBase64(file);
                    const visionContext = await requestVision('Summarize scene for companion memory context.', imageBase64);
                    responseData = await requestRealtimeTurn(content, {
                        vision: visionContext.message || 'vision capture available',
                        image_name: file.name
                    });
                } else {
                    responseData = await requestRealtimeTurn(content, { audio: 'typed-input' });
                }
                if (responseData.status !== 'ok') {
                    throw new Error(responseData.message || 'Model response failed');
                }
                const answer = responseData.reply || responseData.message;
                appendMessage('assistant', answer);
                storeMessage('assistant', answer);
                if (responseData.mood) {
                    setDuplexMood(responseData.mood);
                }
                await speakText(answer);
                setStatus('Ready.');
            } catch (error) {
                appendMessage('system', `Error: ${error.message}`);
                setStatus('Error sending message.');
            } finally {
                isSending = false;
                chatSend.disabled = false;
                setDuplexStatus(duplexVoice, 'idle');
            }
        }

        async function ensureRealtimeSession() {
            if (realtimeSessionId) {
                return realtimeSessionId;
            }
            const response = await fetch('/api/realtime/session/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: 'full-duplex' })
            });
            const data = await response.json();
            if (data.status !== 'ok') {
                throw new Error(data.message || 'Failed to start realtime session');
            }
            realtimeSessionId = data.session_id;
            return realtimeSessionId;
        }

        async function requestRealtimeTurn(prompt, modality = {}) {
            const sessionId = await ensureRealtimeSession();
            const response = await fetch('/api/realtime/turn', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    text: prompt,
                    model: CHAT_TEXT_MODEL,
                    modality
                })
            });
            return response.json();
        }

        async function requestChat() {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: chatMessages,
                    model: CHAT_TEXT_MODEL
                })
            });
            return response.json();
        }

        async function requestVision(prompt, imageBase64) {
            const response = await fetch('/api/vision', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt,
                    image: imageBase64,
                    model: CHAT_VISION_MODEL
                })
            });
            return response.json();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result || '';
                    const base64 = result.toString().split(',')[1] || '';
                    resolve(base64);
                };
                reader.onerror = () => reject(new Error('Failed to read image'));
                reader.readAsDataURL(file);
            });
        }

        chatSend.addEventListener('click', sendChat);
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChat();
            }
        });

        chatClear.addEventListener('click', () => {
            chatLog.innerHTML = '';
            chatMessages.length = 0;
            setStatus('Cleared.');
        });

        chatVoice.addEventListener('click', () => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                appendMessage('system', 'Voice input not supported in this browser.');
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            setStatus('Listening...');
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
                sendChat();
            };
            recognition.onerror = (event) => {
                appendMessage('system', `Voice error: ${event.error}`);
                setStatus('Ready.');
            };
            recognition.onend = () => {
                setStatus('Ready.');
            };
            recognition.start();
        });


        modelSettingsSave.addEventListener('click', async () => {
            try {
                await saveModelSettings();
                setStatus('Model settings saved.');
            } catch (error) {
                appendMessage('system', `Settings save error: ${error.message}`);
            }
        });

        async function callDuplexAction(path, options = {}) {
            const response = await fetch(path, options);
            return response.json();
        }

        if (duplexTalk) {
            const startTalk = () => {
                duplexTalk.classList.add('active');
                callDuplexAction('/api/talk/start').catch((error) => {
                    appendMessage('system', `Talk error: ${error.message}`);
                });
            };

            const stopTalk = () => {
                duplexTalk.classList.remove('active');
                callDuplexAction('/api/talk/stop').catch((error) => {
                    appendMessage('system', `Talk error: ${error.message}`);
                });
            };

            duplexTalk.addEventListener('mousedown', startTalk);
            duplexTalk.addEventListener('mouseup', stopTalk);
            duplexTalk.addEventListener('mouseleave', stopTalk);
            duplexTalk.addEventListener('touchstart', (event) => {
                event.preventDefault();
                startTalk();
            });
            duplexTalk.addEventListener('touchend', stopTalk);
        }

        if (duplexListen) {
            duplexListen.addEventListener('click', async () => {
                setDuplexStatus(duplexMic, 'listening');
                setStatus('Listening for speech...');
                try {
                    const data = await callDuplexAction('/api/listen?duration=4');
                    if (data.status === 'ok') {
                        if (data.text) {
                            appendMessage('user', data.text);
                            storeMessage('user', data.text);
                            chatInput.value = data.text;
                            setDuplexStatus(duplexMic, 'captured');
                            setDuplexMood('thinking');
                            await sendChat();
                        } else {
                            appendMessage('system', 'No speech detected.');
                            setDuplexStatus(duplexMic, 'idle');
                        }
                    } else {
                        throw new Error(data.message || 'Listen failed');
                    }
                } catch (error) {
                    appendMessage('system', `Listen error: ${error.message}`);
                    setDuplexStatus(duplexMic, 'error');
                } finally {
                    setStatus('Ready.');
                    setTimeout(() => setDuplexStatus(duplexMic, 'ready'), 1200);
                    setTimeout(() => setDuplexMood('neutral'), 3000);
                }
            });
        }

        if (duplexAuto) {
            duplexAuto.addEventListener('click', () => {
                autoDuplexEnabled = !autoDuplexEnabled;
                duplexAuto.classList.toggle('active', autoDuplexEnabled);
                duplexAuto.textContent = autoDuplexEnabled ? 'Auto Duplex On' : 'Auto Duplex';
                if (autoDuplexEnabled) {
                    setStatus('Auto duplex enabled. Listening every 8s.');
                    autoDuplexTimer = setInterval(() => {
                        if (!isSending) {
                            duplexListen.click();
                        }
                    }, 8000);
                } else {
                    setStatus('Auto duplex paused.');
                    if (autoDuplexTimer) {
                        clearInterval(autoDuplexTimer);
                        autoDuplexTimer = null;
                    }
                }
            });
        }

        if (duplexBlink) {
            duplexBlink.addEventListener('click', () => {
                callDuplexAction('/api/blink').catch((error) => {
                    appendMessage('system', `Blink error: ${error.message}`);
                });
            });
        }

        if (duplexReset) {
            duplexReset.addEventListener('click', () => {
                callDuplexAction('/api/mood/neutral').catch((error) => {
                    appendMessage('system', `Mood error: ${error.message}`);
                });
                setDuplexMood('neutral');
            });
        }

        const launchpadChecks = Array.from(document.querySelectorAll('input[data-launchpad]'));
        const launchpadStatus = document.getElementById('launchpad-status');
        const launchpadReset = document.getElementById('launchpad-reset');
        const LAUNCHPAD_KEY = 'piguy-launchpad-v1v2v3';

        function updateLaunchpadStatus() {
            const done = launchpadChecks.filter((item) => item.checked).length;
            const total = launchpadChecks.length;
            if (launchpadStatus) {
                launchpadStatus.textContent = `${done}/${total} milestones completed. Keep pushing.`;
            }
        }

        function saveLaunchpadState() {
            const payload = launchpadChecks.reduce((accumulator, checkbox) => {
                accumulator[checkbox.dataset.launchpad] = checkbox.checked;
                return accumulator;
            }, {});
            window.localStorage.setItem(LAUNCHPAD_KEY, JSON.stringify(payload));
            updateLaunchpadStatus();
        }

        function loadLaunchpadState() {
            const rawState = window.localStorage.getItem(LAUNCHPAD_KEY);
            if (!rawState) {
                updateLaunchpadStatus();
                return;
            }
            try {
                const parsedState = JSON.parse(rawState);
                launchpadChecks.forEach((checkbox) => {
                    checkbox.checked = !!parsedState[checkbox.dataset.launchpad];
                });
            } catch (_error) {
                window.localStorage.removeItem(LAUNCHPAD_KEY);
            }
            updateLaunchpadStatus();
        }

        launchpadChecks.forEach((checkbox) => {
            checkbox.addEventListener('change', saveLaunchpadState);
        });

        if (launchpadReset) {
            launchpadReset.addEventListener('click', () => {
                launchpadChecks.forEach((checkbox) => {
                    checkbox.checked = false;
                });
                saveLaunchpadState();
            });
        }

        loadLaunchpadState();
    </script>
</body>
</html>
